# 微信支付功能使用说明

## 功能概述

本系统集成了微信支付功能，支持小程序支付、订单查询、退款等操作。

## 配置说明

### 1. 环境变量配置

在部署前需要设置以下环境变量：

```bash
# 微信小程序配置
WECHAT_APP_ID=your_app_id
WECHAT_MCH_ID=your_mch_id
WECHAT_MCH_KEY=your_mch_key
WECHAT_MCH_SERIAL_NO=your_mch_serial_no

# 证书文件路径
WECHAT_PRIVATE_KEY_PATH=classpath:cert/apiclient_key.pem
WECHAT_CERTIFICATE_PATH=classpath:cert/wechatpay_certificate.pem

# 回调地址
WECHAT_NOTIFY_URL=https://your-domain.com/api/wechat/pay/notify
WECHAT_REFUND_NOTIFY_URL=https://your-domain.com/api/wechat/pay/refund-notify

# 是否启用沙箱环境
WECHAT_SANDBOX=false
```

### 2. 证书文件

需要将微信支付的证书文件放置在 `src/main/resources/cert/` 目录下：

- `apiclient_key.pem` - 商户私钥文件
- `wechatpay_certificate.pem` - 微信支付平台证书文件

### 3. 数据库迁移

执行数据库迁移脚本：

```sql
-- 执行 src/main/resources/sql/migration_wechat_pay.sql
```

## API接口说明

### 1. 创建支付订单

**接口地址：** `POST /api/wechat/pay/create`

**请求参数：**
```json
{
  "orderNo": "20240101120000001",
  "description": "生鲜配送订单",
  "amount": 5000,
  "openid": "user_openid"
}
```

**响应结果：**
```json
{
  "success": true,
  "data": {
    "prepayId": "wx123456789",
    "timeStamp": "1640995200",
    "nonceStr": "abc123",
    "package": "prepay_id=wx123456789",
    "signType": "RSA",
    "paySign": "signature"
  }
}
```

### 2. 查询支付订单

**接口地址：** `GET /api/wechat/pay/query/{orderNo}`

**响应结果：**
```json
{
  "success": true,
  "data": {
    "out_trade_no": "20240101120000001",
    "transaction_id": "wx123456789",
    "trade_state": "SUCCESS",
    "trade_state_desc": "支付成功",
    "amount": {
      "total": 5000,
      "payer_total": 5000
    }
  }
}
```

### 3. 申请退款

**接口地址：** `POST /api/wechat/pay/refund`

**请求参数：**
```json
{
  "orderNo": "20240101120000001",
  "refundNo": "R20240101120000001",
  "totalAmount": 5000,
  "refundAmount": 5000,
  "reason": "用户申请退款"
}
```

### 4. 查询退款

**接口地址：** `GET /api/wechat/pay/refund/query/{refundNo}`

### 5. 关闭订单

**接口地址：** `POST /api/wechat/pay/close/{orderNo}`

### 6. 支付结果通知

**接口地址：** `POST /api/wechat/pay/notify`

微信支付会向此接口发送支付结果通知，系统会自动处理并更新订单状态。

### 7. 退款结果通知

**接口地址：** `POST /api/wechat/pay/refund-notify`

微信支付会向此接口发送退款结果通知。

## 测试接口

为了方便测试，系统提供了测试接口：

### 1. 测试创建支付

**接口地址：** `POST /api/test/payment/create`

**请求参数：**
```json
{
  "orderNo": "20240101120000001",
  "openid": "test_openid"
}
```

### 2. 测试查询支付

**接口地址：** `GET /api/test/payment/query/{orderNo}`

### 3. 测试关闭订单

**接口地址：** `POST /api/test/payment/close/{orderNo}`

### 4. 获取订单信息

**接口地址：** `GET /api/test/payment/order/{orderNo}`

## 订单状态说明

### 订单状态 (status)
- 0: 待发货
- 1: 待付款
- 2: 已付款
- 3: 配送中
- 4: 已送达
- 5: 已完成
- 6: 已取消
- 7: 退款中
- 8: 已退款

### 支付状态 (payment_status)
- 0: 未支付
- 1: 已支付
- 2: 支付失败
- 3: 已退款

## 支付流程

1. **创建订单** - 用户下单，订单状态为"待付款"
2. **发起支付** - 调用创建支付订单接口，获取支付参数
3. **用户支付** - 用户在小程序中完成支付
4. **支付回调** - 微信支付发送支付结果通知
5. **更新状态** - 系统更新订单状态为"待发货"

## 注意事项

1. **金额单位**：所有金额均以"分"为单位
2. **订单号**：订单号必须唯一，建议使用时间戳+随机数
3. **证书安全**：证书文件不要提交到版本控制系统
4. **回调验证**：系统会验证微信支付回调的签名
5. **幂等性**：支付回调可能重复发送，系统已做幂等处理

## 错误处理

系统会记录所有支付相关的错误日志，常见错误：

1. **配置错误**：检查微信支付配置是否正确
2. **证书错误**：检查证书文件是否存在且有效
3. **签名错误**：检查商户密钥是否正确
4. **订单不存在**：检查订单号是否正确
5. **金额不匹配**：检查支付金额是否与订单金额一致

## 开发调试

1. 使用沙箱环境进行开发测试
2. 查看日志文件获取详细错误信息
3. 使用微信支付官方工具验证签名
4. 测试回调接口的可达性